name: Generate Sitemap

env:
  TZ: Asia/Tokyo

on:
  push:

jobs:
  get_articles:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      articles: ${{ steps.sorted_articles.outputs.articles }}
    steps:
      - uses: actions/github-script@v7
        id: sorted_articles
        with:
          result-encoding: json
          script: |
            const exampleUrl = "https://example.com";
            const perPage = 3;
            let maxPage = 1;
            let result = [];
            for (let page = 1; page <= maxPage; page += 1) {
              const res = await fetch(`https://render-sample-1.onrender.com/articles?page=${page}&per_page=${perPage}`, {
                headers: {
                  "Content-Type": "application/json",
                  "x-api-key": "${{ secrets.X_API_KEY }}"
                }
              });
              if (!res.ok) {
                throw new Error(res.text)
              }
              const resJson = await res.json();
              result = resJson.articles.reduce((acc, cur) => {
                return [
                  ...acc,
                  {
                    url: `${exampleUrl}/${cur.route}/${cur.slug}/`,
                    refreshed_at: cur.refreshed_at
                  }
                ]
              }, result);
              maxPage = (resJson.total + perPage - 1) / perPage;
            }
            result.sort((a, b) => {
              return new Date(b.refreshed_at) - new Date(a.refreshed_at);
            })
            return result;
  get_users:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      users: ${{ steps.sorted_users.outputs.users }}
    steps:
      - uses: actions/github-script@v7
        id: sorted_users
        with:
          result-encoding: json
          script: |
            const exampleUrl = "https://example.com";
            const perPage = 3;
            let maxPage = 1;
            let result = [];
            for (let page = 1; page <= maxPage; page += 1) {
              const res = await fetch(`https://render-sample-1.onrender.com/users?page=${page}&per_page=${perPage}`, {
                headers: {
                  "Content-Type": "application/json",
                  "x-api-key": "${{ secrets.X_API_KEY }}"
                }
              });
              if (!res.ok) {
                throw new Error(res.text)
              }
              const resJson = await res.json();
              result = resJson.users.reduce((acc, cur) => {
                return [
                  ...acc,
                  {
                    url: `${exampleUrl}/${cur.id}/`,
                    refreshed_at: cur.refreshed_at
                  }
                ]
              }, result);
              maxPage = (resJson.total + perPage - 1) / perPage;
            }
            result.sort((a, b) => {
              return new Date(b.refreshed_at) - new Date(a.refreshed_at);
            })
            return result;
  show_results:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - get_articles
      - get_users
    steps:
      - name: echo results
        run: |
          echo ${{ needs.get_articles.outputs.articles }}
          echo ${{ needs.get_users.outputs.users }}
